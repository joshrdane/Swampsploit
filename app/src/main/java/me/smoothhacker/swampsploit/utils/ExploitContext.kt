package me.smoothhacker.swampsploit.utils

import android.content.Context
import kotlinx.serialization.InternalSerializationApi
import kotlinx.serialization.KSerializer
import kotlinx.serialization.Serializable
import kotlinx.serialization.descriptors.SerialDescriptor
import kotlinx.serialization.descriptors.buildClassSerialDescriptor
import kotlinx.serialization.descriptors.listSerialDescriptor
import kotlinx.serialization.descriptors.serialDescriptor
import kotlinx.serialization.encoding.Decoder
import kotlinx.serialization.encoding.Encoder
import me.smoothhacker.swampsploit.exploit.Payload
import java.io.File

object ExploitContextSerializer : KSerializer<ExploitContext> {
    @OptIn(InternalSerializationApi::class)
    override val descriptor: SerialDescriptor = buildClassSerialDescriptor("ExploitContext") {
        element("dataDir", serialDescriptor<File>())
        element("hostList", listSerialDescriptor<String>())
        element("targetPort", serialDescriptor<Int>())
        element("timeout", serialDescriptor<Int>())
        element("selectedPayload", serialDescriptor<Payload>())
    }
    override fun deserialize(decoder: Decoder): ExploitContext {
        TODO("Not yet implemented")
    }

    override fun serialize(encoder: Encoder, value: ExploitContext) {
        TODO("Not yet implemented")
    }
}

@Serializable(with = ExploitContextSerializer::class)
class ExploitContext(dataDir: File) {
    private val dataDir: File = dataDir
    private val hostList: ArrayList<String> = ArrayList()
    private var targetPort: Int = 0x1337
    private var timeout: Int = 0
    private var selectedPayload: Payload = Payload(byteArrayOf())

    init {
        // Read from context files
        val hostsListFile = File(this.dataDir, "saved_context.dat")
        hostList.add("")
    }

    fun save() {
        val hostsListFile = File(this.dataDir, "saved_context.dat")
        hostsListFile.bufferedWriter().use { out ->
            hostList.forEach {
                out.write("${it}\n")
            }
        }
    }

    fun getHost(idx: Int): String {
        return this.hostList[idx]
    }

    fun getHost(): String {
        return this.hostList.last()
    }

    fun getHostList(): ArrayList<String> {
        return this.hostList
    }

    fun getPort(): String {
        return this.targetPort.toString()
    }

    fun getTimeout(): String {
        return this.timeout.toString()
    }

    fun getPayload(): Payload {
        return this.selectedPayload
    }

    fun setPort(newVal: Int) {
        this.targetPort = newVal
    }

    fun setTimeout(newVal: Int) {
        this.timeout = newVal
    }

    fun setPayload(newPayload: Payload) {
        this.selectedPayload = newPayload
    }

    fun addHost(newHost: String) {
        this.hostList.add(newHost)
    }
}